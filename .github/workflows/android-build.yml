name: Build and Deploy Android App

on:
  push:
    tags:
      - 'v*'  # Deploy on version tags (e.g., v1.0.0)
  workflow_dispatch:  # Allow manual trigger
    inputs:
      deploy_to_play_store:
        description: 'Deploy to Google Play Store'
        required: true
        default: false
        type: boolean
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build React app
      run: npm run build
      
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
        
    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Install Android SDK components
      run: |
        sdkmanager "platforms;android-34" "platforms;android-35" "build-tools;34.0.0" "build-tools;35.0.0"
      
    - name: Make gradlew executable
      run: chmod +x android/gradlew
      
    - name: Set version code from tag
      if: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') }}
      run: |
        TAG_NAME=${GITHUB_REF#refs/tags/}
        VERSION_CODE=$((10000 + GITHUB_RUN_NUMBER))
        echo "Setting version code to: $VERSION_CODE"
        sed -i "s/versionCode [0-9]*/versionCode $VERSION_CODE/" android/app/build.gradle
        sed -i "s/versionName \"[^\"]*\"/versionName \"$TAG_NAME\"/" android/app/build.gradle
        
    - name: Clean Android build cache
      run: |
        rm -rf android/app/build
        rm -rf android/app/.gradle
        rm -rf android/.gradle
        echo "âœ… Build cache cleaned"
      
    - name: Sync Capacitor
      run: npx cap sync android
      
    - name: Verify package configuration
      run: |
        echo "Checking package configuration..."
        grep -A 5 "applicationId" android/app/build.gradle || true
        grep -A 5 "namespace" android/app/build.gradle || true
        echo "MainActivity location:"
        find android/app/src/main/java -name "MainActivity.java" || true
      
    - name: Check Android setup
      run: |
        echo "Android project structure:"
        ls -la android/
        echo "Gradle wrapper:"
        ls -la android/gradlew || echo "gradlew not found"
        echo "Build gradle:"
        ls -la android/app/build.gradle || echo "build.gradle not found"
      
    - name: Setup keystore for signing
      run: |
        echo "Creating and validating keystore..."
        
        # Check if KEYSTORE_BASE64 secret is set
        if [ -z "${{ secrets.KEYSTORE_BASE64 }}" ]; then
          echo "âŒ ERROR: KEYSTORE_BASE64 secret is not set in GitHub!"
          echo "Please add all required secrets to GitHub repository settings."
          exit 1
        fi
        
        echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > android/app/keystore.jks
        
        # Check file was created and has content
        if [ ! -f android/app/keystore.jks ]; then
          echo "âŒ Keystore file not created"
          exit 1
        fi
        
        SIZE=$(stat -c%s android/app/keystore.jks)
        if [ "$SIZE" -lt 100 ]; then
          echo "âŒ Keystore file is too small ($SIZE bytes) - likely invalid"
          exit 1
        fi
        
        # Validate keystore with keytool
        if ! keytool -list -v -keystore android/app/keystore.jks \
          -storepass "${{ secrets.KEYSTORE_PASSWORD }}" \
          -alias "${{ secrets.KEY_ALIAS }}" 2>&1 | head -20; then
          echo "âŒ Keystore validation failed - check your secrets"
          exit 1
        fi
        
        echo "âœ… Keystore validated successfully ($SIZE bytes)"
        
    - name: Build Android APK
      env:
        KEYSTORE_FILE: keystore.jks
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      run: |
        cd android
        echo "Building with keystore at: app/$KEYSTORE_FILE"
        ls -lh app/keystore.jks || echo "WARNING: Keystore not found"
        ./gradlew clean
        ./gradlew assembleRelease --no-daemon --stacktrace
        
    - name: Build Android App Bundle (AAB)
      env:
        KEYSTORE_FILE: keystore.jks
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      run: |
        cd android
        ./gradlew bundleRelease --no-daemon --stacktrace
        
    - name: Verify signing
      if: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_to_play_store == 'true') }}
      run: |
        if [ -f android/app/build/outputs/apk/release/app-release.apk ]; then
          echo "âœ… APK built successfully"
          # Use build-tools apksigner
          if ! $ANDROID_HOME/build-tools/35.0.0/apksigner verify android/app/build/outputs/apk/release/app-release.apk; then
            echo "âŒ ERROR: APK is NOT properly signed!"
            exit 1
          fi
          echo "âœ… APK is properly signed"
        fi
        if [ -f android/app/build/outputs/bundle/release/app-release.aab ]; then
          echo "âœ… AAB built successfully"
          if ! jarsigner -verify android/app/build/outputs/bundle/release/app-release.aab; then
            echo "âŒ ERROR: AAB is NOT properly signed!"
            echo "This means the keystore setup failed or signing was skipped."
            echo "Check that all secrets are set correctly in GitHub."
            exit 1
          fi
          echo "âœ… AAB is properly signed"
        fi
        
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: chord-dice-apk
        path: android/app/build/outputs/apk/release/app-release*.apk
        
    - name: Upload AAB
      if: ${{ (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) || (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_to_play_store == 'true') }}
      uses: actions/upload-artifact@v4
      with:
        name: chord-dice-aab
        path: android/app/build/outputs/bundle/release/app-release.aab
        
    # NOTE: Manual upload to Play Store - download AAB from artifacts below
    # To enable automatic upload in the future, add SERVICE_ACCOUNT_JSON secret
        
    - name: Create Release Info
      run: |
        echo "## ðŸ“± Guitar Dice v1.9.0 - Android Release" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Build Successful!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **APK**: Ready for sideloading or testing" >> $GITHUB_STEP_SUMMARY
        echo "- **AAB**: Ready for manual Google Play Store upload" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ How to Upload to Google Play Store:" >> $GITHUB_STEP_SUMMARY
        echo "1. Download the **chord-dice-aab** artifact from this workflow" >> $GITHUB_STEP_SUMMARY
        echo "2. Extract the AAB file" >> $GITHUB_STEP_SUMMARY
        echo "3. Go to [Google Play Console](https://play.google.com/console/)" >> $GITHUB_STEP_SUMMARY
        echo "4. Select Guitar Dice â†’ Test and release â†’ Internal testing" >> $GITHUB_STEP_SUMMARY
        echo "5. Create new release and upload the AAB file" >> $GITHUB_STEP_SUMMARY
        echo "6. Review and roll out to testers" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Version Information:" >> $GITHUB_STEP_SUMMARY
        echo "- **Tag**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build**: #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY